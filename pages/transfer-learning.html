
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Transfer Learning &#8212; Machine Learning for Time Series</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'pages/transfer-learning';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Summary" href="conclusion.html" />
    <link rel="prev" title="Simple case: KMeansScorer" href="anomaly/anomaly-detection-kmeansscorer.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Machine Learning for Time Series - Home"/>
    <img src="../_static/logo.png" class="logo__image only-dark pst-js-only" alt="Machine Learning for Time Series - Home"/>
  
  
</a></div>
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="index.html">
                    Time Series Machine Learning
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="introduction/categories.html">Definitions</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction/library.html">Libraries</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Classification</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="classification/overview.html">Overview</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Regression</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="regression/overview.html">Overview</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Forecasting</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="forecasting/overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="forecasting/dart-Transformer-examples.html">Transformer Model</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Clustering</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="clustering/overview.html">Overview</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Hierarchical</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="dart-hierarchical-reconciliation.html">Hierarchical Reconciliation - Australian Tourism Dataset</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Anomaly Detection</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="anomaly/darts-anomaly-detection.html">Anomaly Detection in Darts</a></li>



<li class="toctree-l1"><a class="reference internal" href="anomaly/anomaly-detection-kmeansscorer.html">Simple case: <code class="docutils literal notranslate"><span class="pre">KMeansScorer</span></code></a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Transfer Learning</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Transfer Learning</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Conclusion</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="conclusion.html">Summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="references.html">References</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/khairulislam/Timeseries-ML" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/khairulislam/Timeseries-ML/issues/new?title=Issue%20on%20page%20%2Fpages/transfer-learning.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/pages/transfer-learning.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Transfer Learning</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-0-setup">Part 0: Setup</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#datasets-loading-methods">Datasets loading methods</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-1-local-models-on-the-air-dataset">Part 1: Local models on the <code class="docutils literal notranslate"><span class="pre">air</span></code> dataset</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#inspecting-data">Inspecting Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-useful-function-to-evaluate-models">A useful function to evaluate models</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#building-and-evaluating-models">Building and evaluating models</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-models">Comparing models</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusions-so-far">Conclusions so far</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-2-global-models-on-the-air-dataset">Part 2: Global models on the <code class="docutils literal notranslate"><span class="pre">air</span></code> dataset</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#part-2-1-using-darts-regressionmodels">Part 2.1: Using Darts <code class="docutils literal notranslate"><span class="pre">RegressionModel</span></code>s.</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#part-2-2-using-deep-learning">Part 2.2: Using deep learning</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Conclusions so far</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-3-training-an-n-beats-model-on-m4-dataset-and-use-it-to-forecast-air-dataset">Part 3: Training an N-BEATS model on <code class="docutils literal notranslate"><span class="pre">m4</span></code> dataset and use it to forecast <code class="docutils literal notranslate"><span class="pre">air</span></code> dataset</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Conclusions so far</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#try-training-other-global-models-on-m4-and-applying-on-airline-passengers">Try training other global models on <code class="docutils literal notranslate"><span class="pre">m4</span></code> and applying on airline passengers</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-4-and-recap-use-the-same-model-on-m3-dataset">Part 4 and recap: Use the same model on M3 dataset</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusions">Conclusions</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="transfer-learning">
<h1>Transfer Learning<a class="headerlink" href="#transfer-learning" title="Link to this heading">#</a></h1>
<p>Authors: Julien Herzen, Florian Ravasi, Guillaume Raille, Gaël Grosch.</p>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading">#</a></h2>
<p>The goal of this notebook is to explore transfer learning for time series forecasting – that is, training forecasting models on one time series dataset and using it on another. The notebook is 100% self-contained – i.e., it also contains the necessary commands to install dependencies and download the datasets being used.</p>
<p>Depending on what constitutes a “learning task”, what we call transfer learning here can also be seen under the angle of meta-learning (or “learning to learn”), where models can adapt themselves to new tasks (e.g. forecasting a new time series) at inference time without further training [1].</p>
<p>This notebook is an adaptation of a workshop on “Forecasting and Meta-Learning” that was given at the Applied Machine Learning Days conference in Lausanne, Switzerland, in March 2022.
It contains the following parts:</p>
<ul class="simple">
<li><p><strong>Part 0:</strong> Initial setup - imports, functions to download data, etc.</p></li>
<li><p><strong>Part 1:</strong> Forecasting passenger counts series for 300 airlines (<code class="docutils literal notranslate"><span class="pre">air</span></code> dataset). We will train one model per series.</p></li>
<li><p><strong>Part 2:</strong> Using “global” models - i.e., models trained on all 300 series simultaneously.</p></li>
<li><p><strong>Part 3:</strong> We will try some transfer learning, and see what happens if we train some global models on one (big) dataset (<code class="docutils literal notranslate"><span class="pre">m4</span></code> dataset) and use them on another dataset.</p></li>
<li><p><strong>Part 4:</strong> We will reuse our pre-trained model(s) of Part 3 on another new dataset (<code class="docutils literal notranslate"><span class="pre">m3</span></code> dataset) and see how it compares to models specifically trained on this dataset.</p></li>
</ul>
<p>The compute durations written for the different models have been obtained by running the notebook on a Apple Silicon M2 CPU, with Python 3.10.13 and Darts 0.27.0.</p>
</section>
<section id="part-0-setup">
<h2>Part 0: Setup<a class="headerlink" href="#part-0-setup" title="Link to this heading">#</a></h2>
<p>First, we need to have the right libraries and make the right imports. For the deep learning models, it helps to have a GPU, but this is not mandatory.</p>
<p>The following two cells need to be run only once. They install the dependencies and download all the required datasets.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>xlrd
<span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>darts
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Execute this cell once to download all three datasets</span>
<span class="o">!</span>curl<span class="w"> </span>-L<span class="w"> </span>https://forecasters.org/data/m3comp/M3C.xls<span class="w"> </span>-o<span class="w"> </span>m3_dataset.xls
<span class="o">!</span>curl<span class="w"> </span>-L<span class="w"> </span>https://data.transportation.gov/api/views/xgub-n9bw/rows.csv<span class="w"> </span>-o<span class="w"> </span>carrier_passengers.csv
<span class="o">!</span>curl<span class="w"> </span>-L<span class="w"> </span>https://raw.githubusercontent.com/Mcompetitions/M4-methods/master/Dataset/Train/Monthly-train.csv<span class="w"> </span><span class="err">\</span>
    <span class="o">-</span><span class="n">o</span> <span class="n">m4_monthly</span><span class="o">.</span><span class="n">csv</span>
<span class="o">!</span>curl<span class="w"> </span>-L<span class="w"> </span>https://raw.githubusercontent.com/Mcompetitions/M4-methods/master/Dataset/M4-info.csv<span class="w"> </span>-o<span class="w"> </span>m4_metadata.csv
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 1716k  100 1716k    0     0  6899k      0 --:--:-- --:--:-- --:--:-- 6949k
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 56.3M    0 56.3M    0     0  1747k      0 --:--:--  0:00:33 --:--:-- 2142k
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 87.4M  100 87.4M    0     0  26.2M      0  0:00:03  0:00:03 --:--:-- 26.3M
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 4233k  100 4233k    0     0  5150k      0 --:--:-- --:--:-- --:--:-- 5163k      0      0 --:--:-- --:--:-- --:--:--     0
</pre></div>
</div>
</div>
</div>
<p>And now we import everything. Don’t be afraid, we will uncover what these imports mean through the notebook :)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline

<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>


<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">product</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">MaxAbsScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm.auto</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">darts</span><span class="w"> </span><span class="kn">import</span> <span class="n">TimeSeries</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">darts.dataprocessing.transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">Scaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">darts.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">smape</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">darts.models</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">ARIMA</span><span class="p">,</span>
    <span class="n">ExponentialSmoothing</span><span class="p">,</span>
    <span class="n">KalmanForecaster</span><span class="p">,</span>
    <span class="n">LightGBMModel</span><span class="p">,</span>
    <span class="n">LinearRegressionModel</span><span class="p">,</span>
    <span class="n">NaiveSeasonal</span><span class="p">,</span>
    <span class="n">NBEATSModel</span><span class="p">,</span>
    <span class="n">RandomForest</span><span class="p">,</span>
    <span class="n">Theta</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">darts.utils.losses</span><span class="w"> </span><span class="kn">import</span> <span class="n">SmapeLoss</span>
</pre></div>
</div>
</div>
</div>
<p>We define the forecast horizon here - for all of the (monthly) time series used in this notebook, we’ll be interested in forecasting 18 months in advance. We pick 18 months as this is what is used in the M3/M4 competitions for monthly series.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HORIZON</span> <span class="o">=</span> <span class="mi">18</span>
</pre></div>
</div>
</div>
</div>
<section id="datasets-loading-methods">
<h3>Datasets loading methods<a class="headerlink" href="#datasets-loading-methods" title="Link to this heading">#</a></h3>
<p>Here, we define some helper methods to load the three datasets we’ll be playing with: <code class="docutils literal notranslate"><span class="pre">air</span></code>, <code class="docutils literal notranslate"><span class="pre">m3</span></code> and <code class="docutils literal notranslate"><span class="pre">m4</span></code>.</p>
<p>All the methods below return two list of <code class="docutils literal notranslate"><span class="pre">TimeSeries</span></code>: one list of training series and one list of “test” series (of length <code class="docutils literal notranslate"><span class="pre">HORIZON</span></code>).</p>
<p>For convenience, all the series are already scaled here, by multiplying each of them by a constant so that the largest value is 1. Such scaling is necessary for many models to work correctly (esp. deep learning models). It does not affect the sMAPE values, so we can evaluate the accuracy of our algorithms on the scaled series. In a real application, we would have to keep the Darts <code class="docutils literal notranslate"><span class="pre">Scaler</span></code> objects somewhere in order to inverse-scale the forecasts.</p>
<p>If you are interested in seeing an example of how creating and scaling <code class="docutils literal notranslate"><span class="pre">TimeSeries</span></code> is done, you can inspect the function <code class="docutils literal notranslate"><span class="pre">load_m3()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">load_m3</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">]]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;building M3 TimeSeries...&quot;</span><span class="p">)</span>

    <span class="c1"># Read DataFrame</span>
    <span class="n">df_m3</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s2">&quot;m3_dataset.xls&quot;</span><span class="p">,</span> <span class="s2">&quot;M3Month&quot;</span><span class="p">)</span>

    <span class="c1"># Build TimeSeries</span>
    <span class="n">m3_series</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">df_m3</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">start_year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;Starting Year&quot;</span><span class="p">])</span>
        <span class="n">start_month</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;Starting Month&quot;</span><span class="p">])</span>
        <span class="n">values_series</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">start_month</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">start_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">start_year</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">start_month</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">time_axis</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">values_series</span><span class="p">),</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;M&quot;</span><span class="p">)</span>
        <span class="n">series</span> <span class="o">=</span> <span class="n">TimeSeries</span><span class="o">.</span><span class="n">from_times_and_values</span><span class="p">(</span>
            <span class="n">time_axis</span><span class="p">,</span> <span class="n">values_series</span><span class="o">.</span><span class="n">values</span>
        <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">m3_series</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">There are </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">m3_series</span><span class="p">)</span><span class="si">}</span><span class="s2"> monthly series in the M3 dataset&quot;</span><span class="p">)</span>

    <span class="c1"># Split train/test</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;splitting train/test...&quot;</span><span class="p">)</span>
    <span class="n">m3_train</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="n">HORIZON</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">m3_series</span><span class="p">]</span>
    <span class="n">m3_test</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="n">HORIZON</span><span class="p">:]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">m3_series</span><span class="p">]</span>

    <span class="c1"># Scale so that the largest value is 1</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;scaling...&quot;</span><span class="p">)</span>
    <span class="n">scaler_m3</span> <span class="o">=</span> <span class="n">Scaler</span><span class="p">(</span><span class="n">scaler</span><span class="o">=</span><span class="n">MaxAbsScaler</span><span class="p">())</span>
    <span class="n">m3_train_scaled</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler_m3</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">m3_train</span><span class="p">)</span>
    <span class="n">m3_test_scaled</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler_m3</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">m3_test</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;done. There are </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">m3_train_scaled</span><span class="p">)</span><span class="si">}</span><span class="s2"> series, with average training length </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">m3_train_scaled</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>  <span class="c1"># noqa: E501</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">m3_train_scaled</span><span class="p">,</span> <span class="n">m3_test_scaled</span>


<span class="k">def</span><span class="w"> </span><span class="nf">load_air</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">]]:</span>
    <span class="c1"># download csv file</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;carrier_passengers.csv&quot;</span><span class="p">)</span>
    <span class="c1"># extract relevant columns</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;data_dte&quot;</span><span class="p">,</span> <span class="s2">&quot;carrier&quot;</span><span class="p">,</span> <span class="s2">&quot;Total&quot;</span><span class="p">]]</span>
    <span class="c1"># aggregate per carrier and date</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;carrier&quot;</span><span class="p">,</span> <span class="s2">&quot;data_dte&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="c1"># move indexes to columns</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

    <span class="c1"># group bt carrier, specify time index and target variable</span>
    <span class="n">all_air_series</span> <span class="o">=</span> <span class="n">TimeSeries</span><span class="o">.</span><span class="n">from_group_dataframe</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">group_cols</span><span class="o">=</span><span class="s2">&quot;carrier&quot;</span><span class="p">,</span> <span class="n">time_col</span><span class="o">=</span><span class="s2">&quot;data_dte&quot;</span><span class="p">,</span> <span class="n">value_cols</span><span class="o">=</span><span class="s2">&quot;Total&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;MS&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Split train/test</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;splitting train/test...&quot;</span><span class="p">)</span>
    <span class="n">air_train</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">air_test</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">series</span> <span class="ow">in</span> <span class="n">all_air_series</span><span class="p">:</span>
        <span class="c1"># remove the end of the series</span>
        <span class="n">series</span> <span class="o">=</span> <span class="n">series</span><span class="p">[:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s2">&quot;2019-12-31&quot;</span><span class="p">)]</span>
        <span class="c1"># convert to proper type</span>
        <span class="n">series</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="c1"># extract longest contiguous slice</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">series</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">longest_contiguous_slice</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># remove static covariates</span>
        <span class="n">series</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">with_static_covariates</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="c1"># remove short series</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">36</span> <span class="o">+</span> <span class="n">HORIZON</span><span class="p">:</span>
            <span class="n">air_train</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">series</span><span class="p">[:</span><span class="o">-</span><span class="n">HORIZON</span><span class="p">])</span>
            <span class="n">air_test</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">series</span><span class="p">[</span><span class="o">-</span><span class="n">HORIZON</span><span class="p">:])</span>

    <span class="c1"># Scale so that the largest value is 1</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;scaling series...&quot;</span><span class="p">)</span>
    <span class="n">scaler_air</span> <span class="o">=</span> <span class="n">Scaler</span><span class="p">(</span><span class="n">scaler</span><span class="o">=</span><span class="n">MaxAbsScaler</span><span class="p">())</span>
    <span class="n">air_train_scaled</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler_air</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">air_train</span><span class="p">)</span>
    <span class="n">air_test_scaled</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler_air</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">air_test</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;done. There are </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">air_train_scaled</span><span class="p">)</span><span class="si">}</span><span class="s2"> series, with average training length </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">air_train_scaled</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>  <span class="c1"># noqa: E501</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">air_train_scaled</span><span class="p">,</span> <span class="n">air_test_scaled</span>


<span class="k">def</span><span class="w"> </span><span class="nf">load_m4</span><span class="p">(</span>
    <span class="n">max_number_series</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Due to the size of the dataset, this function takes approximately 10 minutes.</span>

<span class="sd">    Use the `max_number_series` parameter to reduce the computation time if necessary</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Read data dataFrame</span>
    <span class="n">df_m4</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;m4_monthly.csv&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">max_number_series</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df_m4</span> <span class="o">=</span> <span class="n">df_m4</span><span class="p">[:</span><span class="n">max_number_series</span><span class="p">]</span>
    <span class="c1"># Read metadata dataframe</span>
    <span class="n">df_meta</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;m4_metadata.csv&quot;</span><span class="p">)</span>
    <span class="n">df_meta</span> <span class="o">=</span> <span class="n">df_meta</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_meta</span><span class="o">.</span><span class="n">SP</span> <span class="o">==</span> <span class="s2">&quot;Monthly&quot;</span><span class="p">]</span>

    <span class="c1"># Build TimeSeries</span>
    <span class="n">m4_train</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">m4_test</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">df_m4</span><span class="o">.</span><span class="n">iterrows</span><span class="p">(),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df_m4</span><span class="p">)):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">values_series</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span>
            <span class="n">df_meta</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_meta</span><span class="p">[</span><span class="s2">&quot;M4id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;M1&quot;</span><span class="p">,</span> <span class="s2">&quot;StartingDate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">time_axis</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">values_series</span><span class="p">),</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;M&quot;</span><span class="p">)</span>
        <span class="n">series</span> <span class="o">=</span> <span class="n">TimeSeries</span><span class="o">.</span><span class="n">from_times_and_values</span><span class="p">(</span>
            <span class="n">time_axis</span><span class="p">,</span> <span class="n">values_series</span><span class="o">.</span><span class="n">values</span>
        <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="c1"># remove series with less than 48 training samples</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">48</span> <span class="o">+</span> <span class="n">HORIZON</span><span class="p">:</span>
            <span class="c1"># Split train/test</span>
            <span class="n">m4_train</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">series</span><span class="p">[:</span><span class="o">-</span><span class="n">HORIZON</span><span class="p">])</span>
            <span class="n">m4_test</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">series</span><span class="p">[</span><span class="o">-</span><span class="n">HORIZON</span><span class="p">:])</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">There are </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">m4_train</span><span class="p">)</span><span class="si">}</span><span class="s2"> monthly series in the M3 dataset&quot;</span><span class="p">)</span>

    <span class="c1"># Scale so that the largest value is 1</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;scaling...&quot;</span><span class="p">)</span>
    <span class="n">scaler_m4</span> <span class="o">=</span> <span class="n">Scaler</span><span class="p">(</span><span class="n">scaler</span><span class="o">=</span><span class="n">MaxAbsScaler</span><span class="p">())</span>
    <span class="n">m4_train_scaled</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler_m4</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">m4_train</span><span class="p">)</span>
    <span class="n">m4_test_scaled</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler_m4</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">m4_test</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;done. There are </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">m4_train_scaled</span><span class="p">)</span><span class="si">}</span><span class="s2"> series, with average training length </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">m4_train_scaled</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>  <span class="c1"># noqa: E501</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">m4_train_scaled</span><span class="p">,</span> <span class="n">m4_test_scaled</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, we define a handy function to tell us how good a bunch of forecasted series are:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">eval_forecasts</span><span class="p">(</span>
    <span class="n">pred_series</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">],</span> <span class="n">test_series</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;computing sMAPEs...&quot;</span><span class="p">)</span>
    <span class="n">smapes</span> <span class="o">=</span> <span class="n">smape</span><span class="p">(</span><span class="n">test_series</span><span class="p">,</span> <span class="n">pred_series</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">smapes</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Count&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;sMAPE&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Median sMAPE: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">smapes</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">smapes</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="part-1-local-models-on-the-air-dataset">
<h2>Part 1: Local models on the <code class="docutils literal notranslate"><span class="pre">air</span></code> dataset<a class="headerlink" href="#part-1-local-models-on-the-air-dataset" title="Link to this heading">#</a></h2>
<section id="inspecting-data">
<h3>Inspecting Data<a class="headerlink" href="#inspecting-data" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">air</span></code> dataset contains the number of air passengers that flew in or out of the USA per carrier (or airline company) from the year 2000 until 2019.</p>
<p>First, we can load the train and test series by calling <code class="docutils literal notranslate"><span class="pre">load_air()</span></code> function that we have defined above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">air_train</span><span class="p">,</span> <span class="n">air_test</span> <span class="o">=</span> <span class="n">load_air</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>IndexError: The type of your index was not matched.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>splitting train/test...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>IndexError: The type of your index was not matched.
IndexError: The type of your index was not matched.
IndexError: The type of your index was not matched.
IndexError: The type of your index was not matched.
IndexError: The type of your index was not matched.
IndexError: The type of your index was not matched.
IndexError: The type of your index was not matched.
IndexError: The type of your index was not matched.
IndexError: The type of your index was not matched.
IndexError: The type of your index was not matched.
IndexError: The type of your index was not matched.
IndexError: The type of your index was not matched.
IndexError: The type of your index was not matched.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>scaling series...
done. There are 245 series, with average training length 154.06938775510204
</pre></div>
</div>
</div>
</div>
<p>It’s a good idea to start by visualising a few of the series to get a sense of what they look like. We can plot a series by calling <code class="docutils literal notranslate"><span class="pre">series.plot()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">figure</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">200</span><span class="p">]):</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="mi">3</span><span class="p">,</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">air_train</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">air_train</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">components</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/53e0158e89068341a0190d344e4e110226458dd9c97fcacc9e68d9e1459f7229.png" src="../_images/53e0158e89068341a0190d344e4e110226458dd9c97fcacc9e68d9e1459f7229.png" />
</div>
</div>
<p>We can see that most series look quite different, and they even have different time axes! For example some series start in Jan 2001 and others in April 2010.</p>
<p>Let’s see what is the shortest train series available:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">min</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">air_train</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>36
</pre></div>
</div>
</div>
</div>
</section>
<section id="a-useful-function-to-evaluate-models">
<h3>A useful function to evaluate models<a class="headerlink" href="#a-useful-function-to-evaluate-models" title="Link to this heading">#</a></h3>
<p>Below, we write a small function that will make our life easier for quickly trying and comparing different local models. We loop through each serie, fit a model and then evaluate on our test dataset.</p>
<blockquote>
<div><p>⚠️  <code class="docutils literal notranslate"><span class="pre">tqdm</span></code> is optional and is only there to help display the training progress (as you will see it can take some time when training 300+ time series)</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">eval_local_model</span><span class="p">(</span>
    <span class="n">train_series</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">],</span> <span class="n">test_series</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">],</span> <span class="n">model_cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">series</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">train_series</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">model_cls</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">HORIZON</span><span class="p">)</span>
        <span class="n">preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
    <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

    <span class="n">smapes</span> <span class="o">=</span> <span class="n">eval_forecasts</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">test_series</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">smapes</span><span class="p">,</span> <span class="n">elapsed_time</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="building-and-evaluating-models">
<h3>Building and evaluating models<a class="headerlink" href="#building-and-evaluating-models" title="Link to this heading">#</a></h3>
<p>We can now try a first forecasting model on this dataset. As a first step, it is usually a good practice to see how a (very) naive model blindly repeating the last value of the training series performs. This can be done in Darts using a <a class="reference external" href="https://unit8co.github.io/darts/generated_api/darts.models.forecasting.baselines.html#darts.models.forecasting.baselines.NaiveSeasonal">NaiveSeasonal</a> model:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">naive1_smapes</span><span class="p">,</span> <span class="n">naive1_time</span> <span class="o">=</span> <span class="n">eval_local_model</span><span class="p">(</span><span class="n">air_train</span><span class="p">,</span> <span class="n">air_test</span><span class="p">,</span> <span class="n">NaiveSeasonal</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "e29327de9ef8492e8f52377388c6c13a", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>computing sMAPEs...
</pre></div>
</div>
<img alt="../_images/7ce32e73b18cbc4fb667d0cf3de44fdccaae9eabf9138d7f1aecb9ae732af1b4.png" src="../_images/7ce32e73b18cbc4fb667d0cf3de44fdccaae9eabf9138d7f1aecb9ae732af1b4.png" />
</div>
</div>
<p>So the most naive model gives us a median sMAPE of about 27.2.</p>
<p>Can we do better with a “less naive” model exploiting the fact that most monthly series have a seasonality of 12?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">naive12_smapes</span><span class="p">,</span> <span class="n">naive12_time</span> <span class="o">=</span> <span class="n">eval_local_model</span><span class="p">(</span>
    <span class="n">air_train</span><span class="p">,</span> <span class="n">air_test</span><span class="p">,</span> <span class="n">NaiveSeasonal</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="mi">12</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "746368d408d0424d8c3d9fec67f2b755", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>computing sMAPEs...
</pre></div>
</div>
<img alt="../_images/dd8b0109a46c237edcd9ab86eb0eee4430fdfcd0c6a281c8511053269829af2a.png" src="../_images/dd8b0109a46c237edcd9ab86eb0eee4430fdfcd0c6a281c8511053269829af2a.png" />
</div>
</div>
<p>This is better. Let’s try ExponentialSmoothing (by default, for monthly series, it will use a seasonality of 12):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ets_smapes</span><span class="p">,</span> <span class="n">ets_time</span> <span class="o">=</span> <span class="n">eval_local_model</span><span class="p">(</span><span class="n">air_train</span><span class="p">,</span> <span class="n">air_test</span><span class="p">,</span> <span class="n">ExponentialSmoothing</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "8a2234f887714fc6bd7495f74db5d35d", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>computing sMAPEs...
</pre></div>
</div>
<img alt="../_images/c4ad5021b230dcc5d81d571bf138e7bc1d9ee00de76585f4ca0d4f2743713bfd.png" src="../_images/c4ad5021b230dcc5d81d571bf138e7bc1d9ee00de76585f4ca0d4f2743713bfd.png" />
</div>
</div>
<p>The median is slightly better than the naive seasonal model. Another model that we can quickly is the <code class="docutils literal notranslate"><span class="pre">Theta</span></code> method which has won the M3 competition:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">theta_smapes</span><span class="p">,</span> <span class="n">theta_time</span> <span class="o">=</span> <span class="n">eval_local_model</span><span class="p">(</span><span class="n">air_train</span><span class="p">,</span> <span class="n">air_test</span><span class="p">,</span> <span class="n">Theta</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "68339b0193764927af356fc3aa344e0c", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>computing sMAPEs...
</pre></div>
</div>
<img alt="../_images/2e4661a50d2cb7035399037c22b6ad87ee0ac6af3f11bc07197fb6c12ba227a8.png" src="../_images/2e4661a50d2cb7035399037c22b6ad87ee0ac6af3f11bc07197fb6c12ba227a8.png" />
</div>
</div>
<p>And how about ARIMA?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>  <span class="c1"># ARIMA generates lots of warnings</span>
<span class="n">arima_smapes</span><span class="p">,</span> <span class="n">arima_time</span> <span class="o">=</span> <span class="n">eval_local_model</span><span class="p">(</span><span class="n">air_train</span><span class="p">,</span> <span class="n">air_test</span><span class="p">,</span> <span class="n">ARIMA</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "6d8671fd2b774b15b5b973742133f2a2", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>computing sMAPEs...
</pre></div>
</div>
<img alt="../_images/1ea83e4a5beee1599af4e6ba8e570f9a1181923ad59be672951e5642f05b6300.png" src="../_images/1ea83e4a5beee1599af4e6ba8e570f9a1181923ad59be672951e5642f05b6300.png" />
</div>
</div>
<p>Or the Kalman Filter? (in Darts, fitting Kalman filters uses the N4SID system identification algorithm)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kf_smapes</span><span class="p">,</span> <span class="n">kf_time</span> <span class="o">=</span> <span class="n">eval_local_model</span><span class="p">(</span><span class="n">air_train</span><span class="p">,</span> <span class="n">air_test</span><span class="p">,</span> <span class="n">KalmanForecaster</span><span class="p">,</span> <span class="n">dim_x</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "07ccda2d49034473b80c4a577a07b79d", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>computing sMAPEs...
</pre></div>
</div>
<img alt="../_images/574da20bb3a35a2c49968c7ee12e87cc4f3d870e9876e023c3603580afc1134e.png" src="../_images/574da20bb3a35a2c49968c7ee12e87cc4f3d870e9876e023c3603580afc1134e.png" />
</div>
</div>
</section>
<section id="comparing-models">
<h3>Comparing models<a class="headerlink" href="#comparing-models" title="Link to this heading">#</a></h3>
<p>Below, we define a function that will be useful to visualise how models compare to each other in terms of median sMAPE, and time required to obtain the forecasts.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">plot_models</span><span class="p">(</span><span class="n">method_to_elapsed_times</span><span class="p">,</span> <span class="n">method_to_smapes</span><span class="p">):</span>
    <span class="n">shapes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">]</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;tab:blue&quot;</span><span class="p">,</span> <span class="s2">&quot;tab:orange&quot;</span><span class="p">,</span> <span class="s2">&quot;tab:green&quot;</span><span class="p">,</span> <span class="s2">&quot;tab:red&quot;</span><span class="p">,</span> <span class="s2">&quot;tab:purple&quot;</span><span class="p">]</span>
    <span class="n">styles</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">product</span><span class="p">(</span><span class="n">shapes</span><span class="p">,</span> <span class="n">colors</span><span class="p">))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">method</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">method_to_elapsed_times</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">method_to_elapsed_times</span><span class="p">[</span><span class="n">method</span><span class="p">]</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">styles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span>
            <span class="p">[</span><span class="n">t</span><span class="p">],</span>
            <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">method_to_smapes</span><span class="p">[</span><span class="n">method</span><span class="p">])],</span>
            <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">color</span><span class="o">=</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">label</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
            <span class="n">markersize</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;elapsed time [s]&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;median sMAPE over all series&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.4</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">smapes</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;naive-last&quot;</span><span class="p">:</span> <span class="n">naive1_smapes</span><span class="p">,</span>
    <span class="s2">&quot;naive-seasonal&quot;</span><span class="p">:</span> <span class="n">naive12_smapes</span><span class="p">,</span>
    <span class="s2">&quot;Exponential Smoothing&quot;</span><span class="p">:</span> <span class="n">ets_smapes</span><span class="p">,</span>
    <span class="s2">&quot;Theta&quot;</span><span class="p">:</span> <span class="n">theta_smapes</span><span class="p">,</span>
    <span class="s2">&quot;ARIMA&quot;</span><span class="p">:</span> <span class="n">arima_smapes</span><span class="p">,</span>
    <span class="s2">&quot;Kalman Filter&quot;</span><span class="p">:</span> <span class="n">kf_smapes</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">elapsed_times</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;naive-last&quot;</span><span class="p">:</span> <span class="n">naive1_time</span><span class="p">,</span>
    <span class="s2">&quot;naive-seasonal&quot;</span><span class="p">:</span> <span class="n">naive12_time</span><span class="p">,</span>
    <span class="s2">&quot;Exponential Smoothing&quot;</span><span class="p">:</span> <span class="n">ets_time</span><span class="p">,</span>
    <span class="s2">&quot;Theta&quot;</span><span class="p">:</span> <span class="n">theta_time</span><span class="p">,</span>
    <span class="s2">&quot;ARIMA&quot;</span><span class="p">:</span> <span class="n">arima_time</span><span class="p">,</span>
    <span class="s2">&quot;Kalman Filter&quot;</span><span class="p">:</span> <span class="n">kf_time</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">plot_models</span><span class="p">(</span><span class="n">elapsed_times</span><span class="p">,</span> <span class="n">smapes</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/ae61d30e202521284a7d218e4fcf3d6d2d04b17fbaa7ba3823e940ae58fb9b8e.png" src="../_images/ae61d30e202521284a7d218e4fcf3d6d2d04b17fbaa7ba3823e940ae58fb9b8e.png" />
</div>
</div>
</section>
<section id="conclusions-so-far">
<h3>Conclusions so far<a class="headerlink" href="#conclusions-so-far" title="Link to this heading">#</a></h3>
<p>ARIMA gives the best results, but it is also (by far) the most time-consuming model. The Exponential Smoothing model provides an interesting tradeoff, with good forecasting accuracy and lower computational cost. Can we maybe find a better compromise by considering <em>global</em> models - i.e., models that are trained only once, jointly on all time series?</p>
</section>
</section>
<section id="part-2-global-models-on-the-air-dataset">
<h2>Part 2: Global models on the <code class="docutils literal notranslate"><span class="pre">air</span></code> dataset<a class="headerlink" href="#part-2-global-models-on-the-air-dataset" title="Link to this heading">#</a></h2>
<p>In this section we will use “global models” - that is, models that are fit on multiple series at once. Darts has essentially two kinds of global models:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">RegressionModels</span></code> which are wrappers around sklearn-like regression models (Part 2.1).</p></li>
<li><p>PyTorch-based models, which offer various deep learning models (Part 2.2).</p></li>
</ul>
<p>Both models can be trained on multiple series by “tabularizing” the data - i.e., taking many (input, output) sub-slices from all the training series, and training machine learning models in a supervised fashion to predict the output based on the input.</p>
<p>We start by defining a function <code class="docutils literal notranslate"><span class="pre">eval_global_model()</span></code> which works similarly to <code class="docutils literal notranslate"><span class="pre">eval_local_model()</span></code>, but on global models.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">eval_global_model</span><span class="p">(</span>
    <span class="n">train_series</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">],</span> <span class="n">test_series</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">],</span> <span class="n">model_cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">model_cls</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_series</span><span class="p">)</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">HORIZON</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="n">train_series</span><span class="p">)</span>

    <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

    <span class="n">smapes</span> <span class="o">=</span> <span class="n">eval_forecasts</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">test_series</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">smapes</span><span class="p">,</span> <span class="n">elapsed_time</span>
</pre></div>
</div>
</div>
</div>
<section id="part-2-1-using-darts-regressionmodels">
<h3>Part 2.1: Using Darts <code class="docutils literal notranslate"><span class="pre">RegressionModel</span></code>s.<a class="headerlink" href="#part-2-1-using-darts-regressionmodels" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">RegressionModel</span></code> in Darts are forecasting models that can wrap around any “scikit-learn compatible” regression model to obtain forecasts. Compared to deep learning, they represent good “go-to” global models because they typically don’t have many hyper-parameters and can be faster to train. In addition, Darts also offers some “pre-packaged” regression models such as <code class="docutils literal notranslate"><span class="pre">LinearRegressionModel</span></code> and <code class="docutils literal notranslate"><span class="pre">LightGBMModel</span></code>.</p>
<p>We’ll now use our function <code class="docutils literal notranslate"><span class="pre">eval_global_models()</span></code>. In the following cells, we will try using some regression models, for example:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">LinearRegressionModel</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LightGBMModel</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RegressionModel(some_sklearn_model)</span></code></p></li>
</ul>
<p>You can refer to <a class="reference external" href="https://unit8co.github.io/darts/generated_api/darts.models.forecasting.regression_model.html">the API doc</a> for how to use them.</p>
<p>Important parameters are <code class="docutils literal notranslate"><span class="pre">lags</span></code> and <code class="docutils literal notranslate"><span class="pre">output_chunk_length</span></code>. They determine respectively the length of the lookback and “lookforward” windows used by the model, and they correspond to the lengths of the input/output subslices used for training. For instance <code class="docutils literal notranslate"><span class="pre">lags=24</span></code> and <code class="docutils literal notranslate"><span class="pre">output_chunk_length=12</span></code> mean that the model will consume the past 24 lags in order to predict the next 12. In our case, because the shortest training series has length 36, we must have <code class="docutils literal notranslate"><span class="pre">lags</span> <span class="pre">+</span> <span class="pre">output_chunk_length</span> <span class="pre">&lt;=</span> <span class="pre">36</span></code>. (Note that <code class="docutils literal notranslate"><span class="pre">lags</span></code> can also be a list of integers representing the individual lags to be consumed by the model instead of the window length).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_smapes</span><span class="p">,</span> <span class="n">lr_time</span> <span class="o">=</span> <span class="n">eval_global_model</span><span class="p">(</span>
    <span class="n">air_train</span><span class="p">,</span> <span class="n">air_test</span><span class="p">,</span> <span class="n">LinearRegressionModel</span><span class="p">,</span> <span class="n">lags</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">output_chunk_length</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>computing sMAPEs...
</pre></div>
</div>
<img alt="../_images/5a523402a47c059062341286434289965a00c09236e7a36bfb849942857e0672.png" src="../_images/5a523402a47c059062341286434289965a00c09236e7a36bfb849942857e0672.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lgbm_smapes</span><span class="p">,</span> <span class="n">lgbm_time</span> <span class="o">=</span> <span class="n">eval_global_model</span><span class="p">(</span>
    <span class="n">air_train</span><span class="p">,</span> <span class="n">air_test</span><span class="p">,</span> <span class="n">LightGBMModel</span><span class="p">,</span> <span class="n">lags</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">output_chunk_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">objective</span><span class="o">=</span><span class="s2">&quot;mape&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[LightGBM] [Warning] Some label values are &lt; 1 in absolute value. MAPE is unstable with such values, so LightGBM rounds them to 1.0 when calculating MAPE.
[LightGBM] [Info] Auto-choosing col-wise multi-threading, the overhead of testing was 0.003476 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 7649
[LightGBM] [Info] Number of data points in the train set: 30397, number of used features: 30
[LightGBM] [Info] Start training from score 0.481005
computing sMAPEs...
</pre></div>
</div>
<img alt="../_images/2cd7938b636f4f863798a26e65f909c51fab9fe8b088721175ee261994f3f8c3.png" src="../_images/2cd7938b636f4f863798a26e65f909c51fab9fe8b088721175ee261994f3f8c3.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rf_smapes</span><span class="p">,</span> <span class="n">rf_time</span> <span class="o">=</span> <span class="n">eval_global_model</span><span class="p">(</span>
    <span class="n">air_train</span><span class="p">,</span> <span class="n">air_test</span><span class="p">,</span> <span class="n">RandomForest</span><span class="p">,</span> <span class="n">lags</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">output_chunk_length</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>computing sMAPEs...
</pre></div>
</div>
<img alt="../_images/884e8048ca9268e96d5693bead1ba4990749ee20b294ffd7cea9f9cba9a0a278.png" src="../_images/884e8048ca9268e96d5693bead1ba4990749ee20b294ffd7cea9f9cba9a0a278.png" />
</div>
</div>
</section>
<section id="part-2-2-using-deep-learning">
<h3>Part 2.2: Using deep learning<a class="headerlink" href="#part-2-2-using-deep-learning" title="Link to this heading">#</a></h3>
<p>Below, we will train an N-BEATS model on our <code class="docutils literal notranslate"><span class="pre">air</span></code> dataset. Again, you can refer to <a class="reference external" href="https://unit8co.github.io/darts/generated_api/darts.models.forecasting.nbeats.html">the API doc</a> for documentation on the hyper-parameters.
The following hyper-parameters should be a good starting point, and training should take in the order of a minute or two if you’re using a (somewhat slow) Colab GPU.</p>
<p>During training, you can have a look at the <a class="reference external" href="https://arxiv.org/abs/1905.10437">N-BEATS paper</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### Possible N-BEATS hyper-parameters</span>

<span class="c1"># Slicing hyper-params:</span>
<span class="n">IN_LEN</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">OUT_LEN</span> <span class="o">=</span> <span class="mi">4</span>

<span class="c1"># Architecture hyper-params:</span>
<span class="n">NUM_STACKS</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">NUM_BLOCKS</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">NUM_LAYERS</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">LAYER_WIDTH</span> <span class="o">=</span> <span class="mi">136</span>
<span class="n">COEFFS_DIM</span> <span class="o">=</span> <span class="mi">11</span>

<span class="c1"># Training settings:</span>
<span class="n">LR</span> <span class="o">=</span> <span class="mf">1e-3</span>
<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="n">MAX_SAMPLES_PER_TS</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">NUM_EPOCHS</span> <span class="o">=</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s now build, train and predict using an N-BEATS model:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># reproducibility</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">nbeats_model_air</span> <span class="o">=</span> <span class="n">NBEATSModel</span><span class="p">(</span>
    <span class="n">input_chunk_length</span><span class="o">=</span><span class="n">IN_LEN</span><span class="p">,</span>
    <span class="n">output_chunk_length</span><span class="o">=</span><span class="n">OUT_LEN</span><span class="p">,</span>
    <span class="n">num_stacks</span><span class="o">=</span><span class="n">NUM_STACKS</span><span class="p">,</span>
    <span class="n">num_blocks</span><span class="o">=</span><span class="n">NUM_BLOCKS</span><span class="p">,</span>
    <span class="n">num_layers</span><span class="o">=</span><span class="n">NUM_LAYERS</span><span class="p">,</span>
    <span class="n">layer_widths</span><span class="o">=</span><span class="n">LAYER_WIDTH</span><span class="p">,</span>
    <span class="n">expansion_coefficient_dim</span><span class="o">=</span><span class="n">COEFFS_DIM</span><span class="p">,</span>
    <span class="n">loss_fn</span><span class="o">=</span><span class="n">SmapeLoss</span><span class="p">(),</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span>
    <span class="n">optimizer_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="n">LR</span><span class="p">},</span>
    <span class="n">pl_trainer_kwargs</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;enable_progress_bar&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="c1"># change this one to &quot;gpu&quot; if your notebook does run in a GPU environment:</span>
        <span class="s2">&quot;accelerator&quot;</span><span class="p">:</span> <span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span>

<span class="n">nbeats_model_air</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">air_train</span><span class="p">,</span> <span class="n">dataloader_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;num_workers&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span> <span class="n">epochs</span><span class="o">=</span><span class="n">NUM_EPOCHS</span><span class="p">)</span>

<span class="c1"># get predictions</span>
<span class="n">nb_preds</span> <span class="o">=</span> <span class="n">nbeats_model_air</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">series</span><span class="o">=</span><span class="n">air_train</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">HORIZON</span><span class="p">)</span>
<span class="n">nbeats_elapsed_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="n">nbeats_smapes</span> <span class="o">=</span> <span class="n">eval_forecasts</span><span class="p">(</span><span class="n">nb_preds</span><span class="p">,</span> <span class="n">air_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>GPU available: True (mps), used: False
TPU available: False, using: 0 TPU cores
IPU available: False, using: 0 IPUs
HPU available: False, using: 0 HPUs

  | Name          | Type             | Params
---------------------------------------------------
0 | criterion     | SmapeLoss        | 0     
1 | train_metrics | MetricCollection | 0     
2 | val_metrics   | MetricCollection | 0     
3 | stacks        | ModuleList       | 525 K 
---------------------------------------------------
523 K     Trainable params
1.9 K     Non-trainable params
525 K     Total params
2.102     Total estimated model params size (MB)
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "b4f98e6788364a6db49ddc81669b1531", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>`Trainer.fit` stopped: `max_epochs=10` reached.
GPU available: True (mps), used: False
TPU available: False, using: 0 TPU cores
IPU available: False, using: 0 IPUs
HPU available: False, using: 0 HPUs
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "0010ee2296784847b88da8157127fe32", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>computing sMAPEs...
</pre></div>
</div>
<img alt="../_images/702751176c1fcb7c571864165b066ecf4d59203acd91a5a06e0bd70bb1da6b7d.png" src="../_images/702751176c1fcb7c571864165b066ecf4d59203acd91a5a06e0bd70bb1da6b7d.png" />
</div>
</div>
<p>Let’s now look again at our errors -vs- time plot:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">smapes_2</span> <span class="o">=</span> <span class="p">{</span>
    <span class="o">**</span><span class="n">smapes</span><span class="p">,</span>
    <span class="o">**</span><span class="p">{</span>
        <span class="s2">&quot;Linear Regression&quot;</span><span class="p">:</span> <span class="n">lr_smapes</span><span class="p">,</span>
        <span class="s2">&quot;LGBM&quot;</span><span class="p">:</span> <span class="n">lgbm_smapes</span><span class="p">,</span>
        <span class="s2">&quot;Random Forest&quot;</span><span class="p">:</span> <span class="n">rf_smapes</span><span class="p">,</span>
        <span class="s2">&quot;NBeats&quot;</span><span class="p">:</span> <span class="n">nbeats_smapes</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="n">elapsed_times_2</span> <span class="o">=</span> <span class="p">{</span>
    <span class="o">**</span><span class="n">elapsed_times</span><span class="p">,</span>
    <span class="o">**</span><span class="p">{</span>
        <span class="s2">&quot;Linear Regression&quot;</span><span class="p">:</span> <span class="n">lr_time</span><span class="p">,</span>
        <span class="s2">&quot;LGBM&quot;</span><span class="p">:</span> <span class="n">lgbm_time</span><span class="p">,</span>
        <span class="s2">&quot;Random Forest&quot;</span><span class="p">:</span> <span class="n">rf_time</span><span class="p">,</span>
        <span class="s2">&quot;NBeats&quot;</span><span class="p">:</span> <span class="n">nbeats_elapsed_time</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="n">plot_models</span><span class="p">(</span><span class="n">elapsed_times_2</span><span class="p">,</span> <span class="n">smapes_2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/d1a0eada74e46f227fb321cd705fa212d9c9569eac29d182783baebed24da812.png" src="../_images/d1a0eada74e46f227fb321cd705fa212d9c9569eac29d182783baebed24da812.png" />
</div>
</div>
</section>
<section id="id1">
<h3>Conclusions so far<a class="headerlink" href="#id1" title="Link to this heading">#</a></h3>
<p>So it looks like a linear regression model trained jointly on all series is now providing the best tradeoff between accuracy and speed. Linear regression is often the way to go!</p>
<p>Our deep learning model N-BEATS is not doing great. Note that we haven’t tried to tune it to this problem explicitly, doing so might have produced more accurate results. Instead of spending time tuning it though, in the next part we will see if it can do better by being trained on an entirely different dataset.</p>
</section>
</section>
<section id="part-3-training-an-n-beats-model-on-m4-dataset-and-use-it-to-forecast-air-dataset">
<h2>Part 3: Training an N-BEATS model on <code class="docutils literal notranslate"><span class="pre">m4</span></code> dataset and use it to forecast <code class="docutils literal notranslate"><span class="pre">air</span></code> dataset<a class="headerlink" href="#part-3-training-an-n-beats-model-on-m4-dataset-and-use-it-to-forecast-air-dataset" title="Link to this heading">#</a></h2>
<p>Deep learning models often do better when trained on <em>large</em> datasets. Let’s try to load all 48,000 monthly time series in the M4 dataset and train our model once more on this larger dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m4_train</span><span class="p">,</span> <span class="n">m4_test</span> <span class="o">=</span> <span class="n">load_m4</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "f8c95030fa9b4f7685d29e9b7b89977e", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>There are 47087 monthly series in the M3 dataset
scaling...
done. There are 47087 series, with average training length 201.25202285131778
</pre></div>
</div>
</div>
</div>
<p>We can start from the same hyper-parameters as before.</p>
<p>With 48,000 M4 training series being on average ~200 time steps long, we would end up with ~10M training samples. With such a number of training samples, each epoch would take too long. So here, we’ll limit the number of training samples used per series. This is done when calling <code class="docutils literal notranslate"><span class="pre">fit()</span></code> with the parameter <code class="docutils literal notranslate"><span class="pre">max_samples_per_ts</span></code>. We add a new hyper-parameter <code class="docutils literal notranslate"><span class="pre">MAX_SAMPLES_PER_TS</span></code> to capture this.</p>
<p>Since the M4 training series are all slightly longer, we can also use a slightly longer <code class="docutils literal notranslate"><span class="pre">input_chunk_length</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Slicing hyper-params:</span>
<span class="n">IN_LEN</span> <span class="o">=</span> <span class="mi">36</span>
<span class="n">OUT_LEN</span> <span class="o">=</span> <span class="mi">4</span>

<span class="c1"># Architecture hyper-params:</span>
<span class="n">NUM_STACKS</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">NUM_BLOCKS</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">NUM_LAYERS</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">LAYER_WIDTH</span> <span class="o">=</span> <span class="mi">136</span>
<span class="n">COEFFS_DIM</span> <span class="o">=</span> <span class="mi">11</span>

<span class="c1"># Training settings:</span>
<span class="n">LR</span> <span class="o">=</span> <span class="mf">1e-3</span>
<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="n">MAX_SAMPLES_PER_TS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="mi">10</span>  <span class="c1"># &lt;-- new parameter, limiting the number of training samples per series</span>
<span class="p">)</span>
<span class="n">NUM_EPOCHS</span> <span class="o">=</span> <span class="mi">5</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># reproducibility</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">nbeats_model_m4</span> <span class="o">=</span> <span class="n">NBEATSModel</span><span class="p">(</span>
    <span class="n">input_chunk_length</span><span class="o">=</span><span class="n">IN_LEN</span><span class="p">,</span>
    <span class="n">output_chunk_length</span><span class="o">=</span><span class="n">OUT_LEN</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span>
    <span class="n">num_stacks</span><span class="o">=</span><span class="n">NUM_STACKS</span><span class="p">,</span>
    <span class="n">num_blocks</span><span class="o">=</span><span class="n">NUM_BLOCKS</span><span class="p">,</span>
    <span class="n">num_layers</span><span class="o">=</span><span class="n">NUM_LAYERS</span><span class="p">,</span>
    <span class="n">layer_widths</span><span class="o">=</span><span class="n">LAYER_WIDTH</span><span class="p">,</span>
    <span class="n">expansion_coefficient_dim</span><span class="o">=</span><span class="n">COEFFS_DIM</span><span class="p">,</span>
    <span class="n">loss_fn</span><span class="o">=</span><span class="n">SmapeLoss</span><span class="p">(),</span>
    <span class="n">optimizer_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="n">LR</span><span class="p">},</span>
    <span class="n">pl_trainer_kwargs</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;enable_progress_bar&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="c1"># change this one to &quot;gpu&quot; if your notebook does run in a GPU environment:</span>
        <span class="s2">&quot;accelerator&quot;</span><span class="p">:</span> <span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span>

<span class="c1"># Train</span>
<span class="n">nbeats_model_m4</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">m4_train</span><span class="p">,</span>
    <span class="n">dataloader_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;num_workers&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
    <span class="n">epochs</span><span class="o">=</span><span class="n">NUM_EPOCHS</span><span class="p">,</span>
    <span class="n">max_samples_per_ts</span><span class="o">=</span><span class="n">MAX_SAMPLES_PER_TS</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>GPU available: True (mps), used: False
TPU available: False, using: 0 TPU cores
IPU available: False, using: 0 IPUs
HPU available: False, using: 0 HPUs

  | Name          | Type             | Params
---------------------------------------------------
0 | criterion     | SmapeLoss        | 0     
1 | train_metrics | MetricCollection | 0     
2 | val_metrics   | MetricCollection | 0     
3 | stacks        | ModuleList       | 543 K 
---------------------------------------------------
541 K     Trainable params
1.9 K     Non-trainable params
543 K     Total params
2.173     Total estimated model params size (MB)
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "89a6e2a27432420eb8fea47ac953831f", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>`Trainer.fit` stopped: `max_epochs=5` reached.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>NBEATSModel(generic_architecture=True, num_stacks=20, num_blocks=1, num_layers=2, layer_widths=136, expansion_coefficient_dim=11, trend_polynomial_degree=2, dropout=0.0, activation=ReLU, input_chunk_length=36, output_chunk_length=4, batch_size=1024, loss_fn=SmapeLoss(), optimizer_kwargs={&#39;lr&#39;: 0.001}, pl_trainer_kwargs={&#39;enable_progress_bar&#39;: True, &#39;accelerator&#39;: &#39;cpu&#39;})
</pre></div>
</div>
</div>
</div>
<p>We can now use our M4-trained model to get forecasts for the air passengers series. As we use the model in a “meta learning” (or transfer learning) way here, we will be timing only the inference part.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">preds</span> <span class="o">=</span> <span class="n">nbeats_model_m4</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">series</span><span class="o">=</span><span class="n">air_train</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">HORIZON</span><span class="p">)</span>  <span class="c1"># get forecasts</span>
<span class="n">nbeats_m4_elapsed_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="n">nbeats_m4_smapes</span> <span class="o">=</span> <span class="n">eval_forecasts</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">air_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>GPU available: True (mps), used: False
TPU available: False, using: 0 TPU cores
IPU available: False, using: 0 IPUs
HPU available: False, using: 0 HPUs
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "220454be10a74a9799a06ad35dbeabff", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>computing sMAPEs...
</pre></div>
</div>
<img alt="../_images/29078a7147a683121323928354d7926a80f09efbe43f4d3dd28b9de33118b3ec.png" src="../_images/29078a7147a683121323928354d7926a80f09efbe43f4d3dd28b9de33118b3ec.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">smapes_3</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">smapes_2</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s2">&quot;N-BEATS (M4-trained)&quot;</span><span class="p">:</span> <span class="n">nbeats_m4_smapes</span><span class="p">}}</span>

<span class="n">elapsed_times_3</span> <span class="o">=</span> <span class="p">{</span>
    <span class="o">**</span><span class="n">elapsed_times_2</span><span class="p">,</span>
    <span class="o">**</span><span class="p">{</span><span class="s2">&quot;N-BEATS (M4-trained)&quot;</span><span class="p">:</span> <span class="n">nbeats_m4_elapsed_time</span><span class="p">},</span>
<span class="p">}</span>

<span class="n">plot_models</span><span class="p">(</span><span class="n">elapsed_times_3</span><span class="p">,</span> <span class="n">smapes_3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/2d2687589a316a91f0d62a00b5b75686e8b1b171bb2536160f52ab8d2f4fcbd8.png" src="../_images/2d2687589a316a91f0d62a00b5b75686e8b1b171bb2536160f52ab8d2f4fcbd8.png" />
</div>
</div>
<section id="id2">
<h3>Conclusions so far<a class="headerlink" href="#id2" title="Link to this heading">#</a></h3>
<p>Although it’s not the absolute best in terms of accuracy, our N-BEATS model trained on <code class="docutils literal notranslate"><span class="pre">m4</span></code> reaches competitive accuracies. This is quite remarkable because this model has <em>not</em> been trained on <em>any</em> of the <code class="docutils literal notranslate"><span class="pre">air</span></code> series we’ve asked it to forecast! The forecasting step with N-BEATS is more than 1000x faster than the fit-predict step we needed with ARIMA, and also faster than with linear regression.</p>
<p>Just for the fun, we can also inspect manually how this model does on another series – for example, the monthly milk production series available in <code class="docutils literal notranslate"><span class="pre">darts.datasets</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">darts.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">MonthlyMilkDataset</span>

<span class="n">series</span> <span class="o">=</span> <span class="n">MonthlyMilkDataset</span><span class="p">()</span><span class="o">.</span><span class="n">load</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">train</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">series</span><span class="p">[:</span><span class="o">-</span><span class="mi">24</span><span class="p">],</span> <span class="n">series</span><span class="p">[</span><span class="o">-</span><span class="mi">24</span><span class="p">:]</span>

<span class="n">scaler</span> <span class="o">=</span> <span class="n">Scaler</span><span class="p">(</span><span class="n">scaler</span><span class="o">=</span><span class="n">MaxAbsScaler</span><span class="p">())</span>
<span class="n">train</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
<span class="n">val</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
<span class="n">series</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>
<span class="n">pred</span> <span class="o">=</span> <span class="n">nbeats_model_m4</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">series</span><span class="o">=</span><span class="n">train</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>

<span class="n">series</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;actual&quot;</span><span class="p">)</span>
<span class="n">pred</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;0-shot forecast&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>GPU available: True (mps), used: False
TPU available: False, using: 0 TPU cores
IPU available: False, using: 0 IPUs
HPU available: False, using: 0 HPUs
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "01173f28287d44618247baf6db3e5980", "version_major": 2, "version_minor": 0}</script><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Axes: xlabel=&#39;Month&#39;&gt;
</pre></div>
</div>
<img alt="../_images/ac9a4fbe0ee4fff68895d3bfb202580ff79315889b0d6ce997a43233b9fcbf0a.png" src="../_images/ac9a4fbe0ee4fff68895d3bfb202580ff79315889b0d6ce997a43233b9fcbf0a.png" />
</div>
</div>
</section>
<section id="try-training-other-global-models-on-m4-and-applying-on-airline-passengers">
<h3>Try training other global models on <code class="docutils literal notranslate"><span class="pre">m4</span></code> and applying on airline passengers<a class="headerlink" href="#try-training-other-global-models-on-m4-and-applying-on-airline-passengers" title="Link to this heading">#</a></h3>
<p>Let’s now try to train other global models on the M4 dataset in order to see if we can get similar results. Below, we will train some <code class="docutils literal notranslate"><span class="pre">RegressionModel</span></code>s on the full <code class="docutils literal notranslate"><span class="pre">m4</span></code> dataset. This can be quite slow. To have faster training we could use e.g., <code class="docutils literal notranslate"><span class="pre">random.choices(m4_train,</span> <span class="pre">k=5000)</span></code> instead of <code class="docutils literal notranslate"><span class="pre">m4_train</span></code> to limit the size of the training set. We could also specify some small enough value for <code class="docutils literal notranslate"><span class="pre">max_samples_per_ts</span></code> in order to limit the number of training samples.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">lr_model_m4</span> <span class="o">=</span> <span class="n">LinearRegressionModel</span><span class="p">(</span><span class="n">lags</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">output_chunk_length</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">lr_model_m4</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">m4_train</span><span class="p">)</span>

<span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">preds</span> <span class="o">=</span> <span class="n">lr_model_m4</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">HORIZON</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="n">air_train</span><span class="p">)</span>
<span class="n">lr_time_transfer</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tic</span>

<span class="n">lr_smapes_transfer</span> <span class="o">=</span> <span class="n">eval_forecasts</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">air_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>computing sMAPEs...
</pre></div>
</div>
<img alt="../_images/b1bf6bb74a85500abbbcdb5e3f90d4b0a34599b380d713f5036f444ded6c6fca.png" src="../_images/b1bf6bb74a85500abbbcdb5e3f90d4b0a34599b380d713f5036f444ded6c6fca.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">lgbm_model_m4</span> <span class="o">=</span> <span class="n">LightGBMModel</span><span class="p">(</span><span class="n">lags</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">output_chunk_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">objective</span><span class="o">=</span><span class="s2">&quot;mape&quot;</span><span class="p">)</span>
<span class="n">lgbm_model_m4</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">m4_train</span><span class="p">)</span>

<span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">preds</span> <span class="o">=</span> <span class="n">lgbm_model_m4</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">HORIZON</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="n">air_train</span><span class="p">)</span>
<span class="n">lgbm_time_transfer</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tic</span>

<span class="n">lgbm_smapes_transfer</span> <span class="o">=</span> <span class="n">eval_forecasts</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">air_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[LightGBM] [Warning] Some label values are &lt; 1 in absolute value. MAPE is unstable with such values, so LightGBM rounds them to 1.0 when calculating MAPE.
[LightGBM] [Info] Auto-choosing row-wise multi-threading, the overhead of testing was 0.097573 seconds.
You can set `force_row_wise=true` to remove the overhead.
And if memory is not enough, you can set `force_col_wise=true`.
[LightGBM] [Info] Total Bins 7650
[LightGBM] [Info] Number of data points in the train set: 8063744, number of used features: 30
[LightGBM] [Info] Start training from score 0.722222
computing sMAPEs...
</pre></div>
</div>
<img alt="../_images/4dcfd8cf12e875f8a141d30c60905420f5d1305a9072d623bb1a75e20a8b8422.png" src="../_images/4dcfd8cf12e875f8a141d30c60905420f5d1305a9072d623bb1a75e20a8b8422.png" />
</div>
</div>
<p>Finally, let’s plot these new results as well:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">smapes_4</span> <span class="o">=</span> <span class="p">{</span>
    <span class="o">**</span><span class="n">smapes_3</span><span class="p">,</span>
    <span class="o">**</span><span class="p">{</span>
        <span class="s2">&quot;Linear Reg (M4-trained)&quot;</span><span class="p">:</span> <span class="n">lr_smapes_transfer</span><span class="p">,</span>
        <span class="s2">&quot;LGBM (M4-trained)&quot;</span><span class="p">:</span> <span class="n">lgbm_smapes_transfer</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="n">elapsed_times_4</span> <span class="o">=</span> <span class="p">{</span>
    <span class="o">**</span><span class="n">elapsed_times_3</span><span class="p">,</span>
    <span class="o">**</span><span class="p">{</span>
        <span class="s2">&quot;Linear Reg (M4-trained)&quot;</span><span class="p">:</span> <span class="n">lr_time_transfer</span><span class="p">,</span>
        <span class="s2">&quot;LGBM (M4-trained)&quot;</span><span class="p">:</span> <span class="n">lgbm_time_transfer</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="n">plot_models</span><span class="p">(</span><span class="n">elapsed_times_4</span><span class="p">,</span> <span class="n">smapes_4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/ec4ded825c9e203524ef1e3643afdd9475df7338323f000fa998be6073f0b575.png" src="../_images/ec4ded825c9e203524ef1e3643afdd9475df7338323f000fa998be6073f0b575.png" />
</div>
</div>
</section>
</section>
<section id="part-4-and-recap-use-the-same-model-on-m3-dataset">
<h2>Part 4 and recap: Use the same model on M3 dataset<a class="headerlink" href="#part-4-and-recap-use-the-same-model-on-m3-dataset" title="Link to this heading">#</a></h2>
<p>OK, now, were we lucky with the airline passengers dataset? Let’s see by repeating the entire process on a new dataset :) You will see that it actually requires very few lines of code. As a new dataset, we will use <code class="docutils literal notranslate"><span class="pre">m3</span></code>, which contains about 1,400 monthly series from the M3 competition.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m3_train</span><span class="p">,</span> <span class="n">m3_test</span> <span class="o">=</span> <span class="n">load_m3</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>building M3 TimeSeries...
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "ba15df754c884c41bdd3a08ceb985fe0", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>There are 1399 monthly series in the M3 dataset
splitting train/test...
scaling...
done. There are 1399 series, with average training length 100.30092923516797
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">naive1_smapes_m3</span><span class="p">,</span> <span class="n">naive1_time_m3</span> <span class="o">=</span> <span class="n">eval_local_model</span><span class="p">(</span>
    <span class="n">m3_train</span><span class="p">,</span> <span class="n">m3_test</span><span class="p">,</span> <span class="n">NaiveSeasonal</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "d6b4cc93cb2e43d98b5cd9e2820bdab7", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>computing sMAPEs...
</pre></div>
</div>
<img alt="../_images/e25bd912705d8518f4c9af88bf2c9d3ec9cbe38578576620d445126cd4de3c6b.png" src="../_images/e25bd912705d8518f4c9af88bf2c9d3ec9cbe38578576620d445126cd4de3c6b.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">naive12_smapes_m3</span><span class="p">,</span> <span class="n">naive12_time_m3</span> <span class="o">=</span> <span class="n">eval_local_model</span><span class="p">(</span>
    <span class="n">m3_train</span><span class="p">,</span> <span class="n">m3_test</span><span class="p">,</span> <span class="n">NaiveSeasonal</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="mi">12</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "f9c8c99221c244d081985a071c189b2b", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>computing sMAPEs...
</pre></div>
</div>
<img alt="../_images/bc5cf8bc0d8231885832f1c5f8e1be66cefd287648af71fb449f3a39febc0494.png" src="../_images/bc5cf8bc0d8231885832f1c5f8e1be66cefd287648af71fb449f3a39febc0494.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ets_smapes_m3</span><span class="p">,</span> <span class="n">ets_time_m3</span> <span class="o">=</span> <span class="n">eval_local_model</span><span class="p">(</span><span class="n">m3_train</span><span class="p">,</span> <span class="n">m3_test</span><span class="p">,</span> <span class="n">ExponentialSmoothing</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "d8476785ec004819ad0738f4ecc95949", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>computing sMAPEs...
</pre></div>
</div>
<img alt="../_images/a143bda61d413f116fed6d80b2bd81387ca74333059b590d8ed6da588e28075f.png" src="../_images/a143bda61d413f116fed6d80b2bd81387ca74333059b590d8ed6da588e28075f.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">theta_smapes_m3</span><span class="p">,</span> <span class="n">theta_time_m3</span> <span class="o">=</span> <span class="n">eval_local_model</span><span class="p">(</span><span class="n">m3_train</span><span class="p">,</span> <span class="n">m3_test</span><span class="p">,</span> <span class="n">Theta</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "81975e241d064fbbaf6d2c76361185cc", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>computing sMAPEs...
</pre></div>
</div>
<img alt="../_images/d07c37743d46af371b0c52e105754131e3a6b00b4adfe6740117c1c4596bb764.png" src="../_images/d07c37743d46af371b0c52e105754131e3a6b00b4adfe6740117c1c4596bb764.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>  <span class="c1"># ARIMA generates lots of warnings</span>

<span class="c1"># Note: using q=1 here generates errors for some series, so we use q=0</span>
<span class="n">arima_smapes_m3</span><span class="p">,</span> <span class="n">arima_time_m3</span> <span class="o">=</span> <span class="n">eval_local_model</span><span class="p">(</span>
    <span class="n">m3_train</span><span class="p">,</span> <span class="n">m3_test</span><span class="p">,</span> <span class="n">ARIMA</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mi">0</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "cb000a21bbcb4602bb36715c60d81f5b", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>computing sMAPEs...
</pre></div>
</div>
<img alt="../_images/28acdd74e4169e47caa1a1fa372e91cc001d97046122559cdc7fb9d41aadbf83.png" src="../_images/28acdd74e4169e47caa1a1fa372e91cc001d97046122559cdc7fb9d41aadbf83.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kf_smapes_m3</span><span class="p">,</span> <span class="n">kf_time_m3</span> <span class="o">=</span> <span class="n">eval_local_model</span><span class="p">(</span>
    <span class="n">m3_train</span><span class="p">,</span> <span class="n">m3_test</span><span class="p">,</span> <span class="n">KalmanForecaster</span><span class="p">,</span> <span class="n">dim_x</span><span class="o">=</span><span class="mi">12</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "a864e5f3d64d48f1aabea68cab435655", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>computing sMAPEs...
</pre></div>
</div>
<img alt="../_images/f32bdc8c1695e5707dd8f0d7bc02299036ed056999f6aa825d229e27801e436c.png" src="../_images/f32bdc8c1695e5707dd8f0d7bc02299036ed056999f6aa825d229e27801e436c.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_smapes_m3</span><span class="p">,</span> <span class="n">lr_time_m3</span> <span class="o">=</span> <span class="n">eval_global_model</span><span class="p">(</span>
    <span class="n">m3_train</span><span class="p">,</span> <span class="n">m3_test</span><span class="p">,</span> <span class="n">LinearRegressionModel</span><span class="p">,</span> <span class="n">lags</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">output_chunk_length</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>computing sMAPEs...
</pre></div>
</div>
<img alt="../_images/771f45527e9afffb38d19c35ac1f809788f435e06b90b96ffaa1c5887e88478d.png" src="../_images/771f45527e9afffb38d19c35ac1f809788f435e06b90b96ffaa1c5887e88478d.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lgbm_smapes_m3</span><span class="p">,</span> <span class="n">lgbm_time_m3</span> <span class="o">=</span> <span class="n">eval_global_model</span><span class="p">(</span>
    <span class="n">m3_train</span><span class="p">,</span> <span class="n">m3_test</span><span class="p">,</span> <span class="n">LightGBMModel</span><span class="p">,</span> <span class="n">lags</span><span class="o">=</span><span class="mi">35</span><span class="p">,</span> <span class="n">output_chunk_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">objective</span><span class="o">=</span><span class="s2">&quot;mape&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[LightGBM] [Warning] Some label values are &lt; 1 in absolute value. MAPE is unstable with such values, so LightGBM rounds them to 1.0 when calculating MAPE.
[LightGBM] [Info] Auto-choosing col-wise multi-threading, the overhead of testing was 0.004819 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 8925
[LightGBM] [Info] Number of data points in the train set: 91356, number of used features: 35
[LightGBM] [Info] Start training from score 0.771293
computing sMAPEs...
</pre></div>
</div>
<img alt="../_images/a3e2dd08baf21c0df57f5a7efd7aef021638fc931b778652bf8ebf43f4147802.png" src="../_images/a3e2dd08baf21c0df57f5a7efd7aef021638fc931b778652bf8ebf43f4147802.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get forecasts with our pre-trained N-BEATS</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">preds</span> <span class="o">=</span> <span class="n">nbeats_model_m4</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">series</span><span class="o">=</span><span class="n">m3_train</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">HORIZON</span><span class="p">)</span>  <span class="c1"># get forecasts</span>
<span class="n">nbeats_m4_elapsed_time_m3</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="n">nbeats_m4_smapes_m3</span> <span class="o">=</span> <span class="n">eval_forecasts</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">m3_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>GPU available: True (mps), used: False
TPU available: False, using: 0 TPU cores
IPU available: False, using: 0 IPUs
HPU available: False, using: 0 HPUs
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "a884d556172348d79d14cb2d8ecce3f2", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>computing sMAPEs...
</pre></div>
</div>
<img alt="../_images/8a47a9de6a2ec9150eedde1ea52f8ecbf0840c4ad6936e28f0cc26736eae3786.png" src="../_images/8a47a9de6a2ec9150eedde1ea52f8ecbf0840c4ad6936e28f0cc26736eae3786.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get forecasts with our pre-trained linear regression model</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">preds</span> <span class="o">=</span> <span class="n">lr_model_m4</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">series</span><span class="o">=</span><span class="n">m3_train</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">HORIZON</span><span class="p">)</span>  <span class="c1"># get forecasts</span>
<span class="n">lr_m4_elapsed_time_m3</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="n">lr_m4_smapes_m3</span> <span class="o">=</span> <span class="n">eval_forecasts</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">m3_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>computing sMAPEs...
</pre></div>
</div>
<img alt="../_images/9c36b033a8a2978f605cdbfdd9c2167b95378746276754af373a49527de4c949.png" src="../_images/9c36b033a8a2978f605cdbfdd9c2167b95378746276754af373a49527de4c949.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get forecasts with our pre-trained LightGBM model</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">preds</span> <span class="o">=</span> <span class="n">lgbm_model_m4</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">series</span><span class="o">=</span><span class="n">m3_train</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">HORIZON</span><span class="p">)</span>  <span class="c1"># get forecasts</span>
<span class="n">lgbm_m4_elapsed_time_m3</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="n">lgbm_m4_smapes_m3</span> <span class="o">=</span> <span class="n">eval_forecasts</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">m3_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>computing sMAPEs...
</pre></div>
</div>
<img alt="../_images/8890a7d9ba8b7e040b00be6e44573be78b51f1d52e6f591fc2e56065e51d933b.png" src="../_images/8890a7d9ba8b7e040b00be6e44573be78b51f1d52e6f591fc2e56065e51d933b.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">smapes_m3</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;naive-last&quot;</span><span class="p">:</span> <span class="n">naive1_smapes_m3</span><span class="p">,</span>
    <span class="s2">&quot;naive-seasonal&quot;</span><span class="p">:</span> <span class="n">naive12_smapes_m3</span><span class="p">,</span>
    <span class="s2">&quot;Exponential Smoothing&quot;</span><span class="p">:</span> <span class="n">ets_smapes_m3</span><span class="p">,</span>
    <span class="s2">&quot;ARIMA&quot;</span><span class="p">:</span> <span class="n">arima_smapes_m3</span><span class="p">,</span>
    <span class="s2">&quot;Theta&quot;</span><span class="p">:</span> <span class="n">theta_smapes_m3</span><span class="p">,</span>
    <span class="s2">&quot;Kalman filter&quot;</span><span class="p">:</span> <span class="n">kf_smapes_m3</span><span class="p">,</span>
    <span class="s2">&quot;Linear Regression&quot;</span><span class="p">:</span> <span class="n">lr_smapes_m3</span><span class="p">,</span>
    <span class="s2">&quot;LGBM&quot;</span><span class="p">:</span> <span class="n">lgbm_smapes_m3</span><span class="p">,</span>
    <span class="s2">&quot;N-BEATS (M4-trained)&quot;</span><span class="p">:</span> <span class="n">nbeats_m4_smapes_m3</span><span class="p">,</span>
    <span class="s2">&quot;Linear Reg (M4-trained)&quot;</span><span class="p">:</span> <span class="n">lr_m4_smapes_m3</span><span class="p">,</span>
    <span class="s2">&quot;LGBM (M4-trained)&quot;</span><span class="p">:</span> <span class="n">lgbm_m4_smapes_m3</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">times_m3</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;naive-last&quot;</span><span class="p">:</span> <span class="n">naive1_time_m3</span><span class="p">,</span>
    <span class="s2">&quot;naive-seasonal&quot;</span><span class="p">:</span> <span class="n">naive12_time_m3</span><span class="p">,</span>
    <span class="s2">&quot;Exponential Smoothing&quot;</span><span class="p">:</span> <span class="n">ets_time_m3</span><span class="p">,</span>
    <span class="s2">&quot;ARIMA&quot;</span><span class="p">:</span> <span class="n">arima_time_m3</span><span class="p">,</span>
    <span class="s2">&quot;Theta&quot;</span><span class="p">:</span> <span class="n">theta_time_m3</span><span class="p">,</span>
    <span class="s2">&quot;Kalman filter&quot;</span><span class="p">:</span> <span class="n">kf_time_m3</span><span class="p">,</span>
    <span class="s2">&quot;Linear Regression&quot;</span><span class="p">:</span> <span class="n">lr_time_m3</span><span class="p">,</span>
    <span class="s2">&quot;LGBM&quot;</span><span class="p">:</span> <span class="n">lgbm_time_m3</span><span class="p">,</span>
    <span class="s2">&quot;N-BEATS (M4-trained)&quot;</span><span class="p">:</span> <span class="n">nbeats_m4_elapsed_time_m3</span><span class="p">,</span>
    <span class="s2">&quot;Linear Reg (M4-trained)&quot;</span><span class="p">:</span> <span class="n">lr_m4_elapsed_time_m3</span><span class="p">,</span>
    <span class="s2">&quot;LGBM (M4-trained)&quot;</span><span class="p">:</span> <span class="n">lgbm_m4_elapsed_time_m3</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">plot_models</span><span class="p">(</span><span class="n">times_m3</span><span class="p">,</span> <span class="n">smapes_m3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/12070418e83e8179dc4b757f73e5ed220d93fbcf2d111ada3fded54de666f375.png" src="../_images/12070418e83e8179dc4b757f73e5ed220d93fbcf2d111ada3fded54de666f375.png" />
</div>
</div>
<p>Here too, the pre-trained N-BEATS model obtains reasonable accuracy, although not as good as the most accurate models. Note also that Exponential Smoothing and Kalman Filter now perform much better than when we used them on the air passengers series. ARIMA performs best but is about 1000x slower than N-BEATS, which didn’t require any training and takes about 15 ms per time series to produce its forecasts. Recall that this N-BEATS model has <em>never</em> been trained on <em>any</em> of the series we’re asking it to forecast.</p>
</section>
<section id="conclusions">
<h2>Conclusions<a class="headerlink" href="#conclusions" title="Link to this heading">#</a></h2>
<p>Transfer learning and meta learning is definitely an interesting phenomenon that is at the moment under-explored in time series forecasting. When does it succeed? When does it fail? Can fine tuning help? When should it be used? Many of these questions still have to be explored but we hope to have shown that doing so is quite easy with Darts models.</p>
<p>Now, which method is best for your case? As always, it depends. If you’re dealing mostly with isolated series that have a sufficient history, classical methods such as ARIMA will get you a long way. Even on larger datasets, if compute power is not too much an issue, they can represent interesting out-of-the-box options. On the other hand if you’re dealing with larger number of series, or series of higher dimensionalities, ML methods and global models will often be the way to go. They can capture patterns across wide ranges of different time series, and are in general faster to run. Don’t under-estimate linear regression based models in this category! If you have reasons to believe you need to capture more complex patterns, or if inference speed is <em>really</em> important for you, give deep learning methods a shot. N-BEATS has proved its worth for meta-learning [1], but this can potentially work with other models too.</p>
<p>[1] Oreshkin et al., “Meta-learning framework with applications to zero-shot time-series forecasting”, 2020, <a class="reference external" href="https://arxiv.org/abs/2002.02887">https://arxiv.org/abs/2002.02887</a></p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./pages"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="anomaly/anomaly-detection-kmeansscorer.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Simple case: <code class="docutils literal notranslate"><span class="pre">KMeansScorer</span></code></p>
      </div>
    </a>
    <a class="right-next"
       href="conclusion.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Summary</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-0-setup">Part 0: Setup</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#datasets-loading-methods">Datasets loading methods</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-1-local-models-on-the-air-dataset">Part 1: Local models on the <code class="docutils literal notranslate"><span class="pre">air</span></code> dataset</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#inspecting-data">Inspecting Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-useful-function-to-evaluate-models">A useful function to evaluate models</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#building-and-evaluating-models">Building and evaluating models</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-models">Comparing models</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusions-so-far">Conclusions so far</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-2-global-models-on-the-air-dataset">Part 2: Global models on the <code class="docutils literal notranslate"><span class="pre">air</span></code> dataset</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#part-2-1-using-darts-regressionmodels">Part 2.1: Using Darts <code class="docutils literal notranslate"><span class="pre">RegressionModel</span></code>s.</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#part-2-2-using-deep-learning">Part 2.2: Using deep learning</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Conclusions so far</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-3-training-an-n-beats-model-on-m4-dataset-and-use-it-to-forecast-air-dataset">Part 3: Training an N-BEATS model on <code class="docutils literal notranslate"><span class="pre">m4</span></code> dataset and use it to forecast <code class="docutils literal notranslate"><span class="pre">air</span></code> dataset</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Conclusions so far</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#try-training-other-global-models-on-m4-and-applying-on-airline-passengers">Try training other global models on <code class="docutils literal notranslate"><span class="pre">m4</span></code> and applying on airline passengers</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-4-and-recap-use-the-same-model-on-m3-dataset">Part 4 and recap: Use the same model on M3 dataset</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusions">Conclusions</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Md Khairul Islam
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>